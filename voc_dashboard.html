<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOC 분석 대시보드</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 10px;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th,
        .stats-table td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .stats-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .percentage {
            color: #667eea;
            font-weight: bold;
        }

        .priority-high {
            background: #ffebee;
            color: #c62828;
        }

        .priority-medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .priority-low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .insights {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .insights h3 {
            color: #d84315;
            margin-bottom: 15px;
        }

        .insights ul {
            list-style-type: none;
        }

        .insights li {
            padding: 8px 0;
            border-left: 3px solid #ff5722;
            padding-left: 15px;
            margin-bottom: 10px;
        }

        .data-refresh {
            text-align: center;
            margin: 20px 0;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📊 VOC 분석 대시보드</h1>
        <p>서비스 고도화 및 영업메시지 강화를 위한 고객 의견 분석</p>
    </div>

    <div class="container">
        <div class="data-refresh">
            <button class="refresh-btn" onclick="loadVOCData()">📊 데이터 새로고침</button>
            <p><small>마지막 업데이트: <span id="lastUpdate">-</span></small></p>
        </div>

        <!-- KPI 카드들 -->
        <div class="dashboard-grid">
            
            <!-- 주요 VOC 유형 통계 -->
            <div class="card">
                <h3>🔥 VOC 유형별 분포</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>VOC 유형</th>
                            <th>건수</th>
                            <th>비율</th>
                        </tr>
                    </thead>
                    <tbody id="reasonStatsTable">
                        <!-- 데이터 로딩 중... -->
                    </tbody>
                </table>
            </div>

            <!-- 서비스 개선 우선순위 -->
            <div class="card">
                <h3>⚡ 서비스 개선 우선순위</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>카테고리</th>
                            <th>빈도</th>
                            <th>긴급도</th>
                            <th>우선순위</th>
                        </tr>
                    </thead>
                    <tbody id="priorityTable">
                        <!-- 데이터 로딩 중... -->
                    </tbody>
                </table>
            </div>

            <!-- 월별 트렌드 차트 -->
            <div class="card" style="grid-column: span 2;">
                <h3>📈 월별 VOC 트렌드</h3>
                <div class="chart-container">
                    <canvas id="monthlyTrendChart"></canvas>
                </div>
            </div>

            <!-- 시간대별 분포 -->
            <div class="card">
                <h3>🕐 시간대별 VOC 분포</h3>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <!-- 쇼핑몰별 분석 -->
            <div class="card">
                <h3>🏪 쇼핑몰별 VOC 분포</h3>
                <div class="chart-container">
                    <canvas id="customerTypeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 인사이트 섹션 -->
        <div class="insights">
            <h3>💡 핵심 인사이트 및 액션 아이템</h3>
            <ul id="insights-list">
                <!-- JavaScript로 동적 생성 -->
            </ul>
        </div>
    </div>

    <script>
        // API 설정
        const API_BASE_URL = './api/voc_data.php';
        
        // 샘플 데이터 (API 호출 실패 시 폴백)
        const sampleData = {
            reasonStats: [
                {reason_category: 'K2K_SALES', count: 245, percentage: 28.5},
                {reason_category: 'K2G_SALES', count: 187, percentage: 21.7},
                {reason_category: 'RETENTION', count: 156, percentage: 18.1},
                {reason_category: 'K2K_MARKET', count: 98, percentage: 11.4},
                {reason_category: 'K2G_MARKET', count: 76, percentage: 8.8},
                {reason_category: 'TOP_SALES', count: 54, percentage: 6.3},
                {reason_category: 'ETC', count: 32, percentage: 3.7}
            ],
            priorityData: [
                {reason_category: 'K2K_SALES', frequency: 245, avg_urgency: 5.0, priority_score: 1225.0},
                {reason_category: 'K2G_SALES', frequency: 187, avg_urgency: 4.8, priority_score: 897.6},
                {reason_category: 'RETENTION', frequency: 156, avg_urgency: 4.5, priority_score: 702.0},
                {reason_category: 'K2K_MARKET', frequency: 98, avg_urgency: 4.2, priority_score: 411.6},
                {reason_category: 'K2G_MARKET', frequency: 76, avg_urgency: 4.0, priority_score: 304.0}
            ],
            monthlyTrend: [
                {month: '2024-09', reason_category: 'K2K_SALES', count: 82},
                {month: '2024-09', reason_category: 'K2G_SALES', count: 65},
                {month: '2024-10', reason_category: 'K2K_SALES', count: 95},
                {month: '2024-10', reason_category: 'K2G_SALES', count: 78},
                {month: '2024-11', reason_category: 'K2K_SALES', count: 103},
                {month: '2024-11', reason_category: 'K2G_SALES', count: 89}
            ],
            hourlyData: [
                {hour: 9, count: 45}, {hour: 10, count: 67}, {hour: 11, count: 89},
                {hour: 12, count: 95}, {hour: 13, count: 78}, {hour: 14, count: 123},
                {hour: 15, count: 145}, {hour: 16, count: 167}, {hour: 17, count: 134},
                {hour: 18, count: 98}, {hour: 19, count: 76}, {hour: 20, count: 54}
            ],
            customerData: [
                {customer_type: 'mall66', count: 423},
                {customer_type: 'mall77', count: 267},
                {customer_type: 'mall88', count: 198},
                {customer_type: 'mall99', count: 89},
                {customer_type: 'mall55', count: 45}
            ]
        };

        let charts = {};

        // API에서 VOC 데이터 가져오기
        async function fetchVOCData() {
            try {
                showLoading(true);
                
                const response = await fetch(`${API_BASE_URL}?type=all&timestamp=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // API 오류 응답 체크
                if (data.error) {
                    throw new Error(data.message || 'API 오류 발생');
                }
                
                return data;
                
            } catch (error) {
                console.error('API 호출 실패:', error);
                
                // 오류 메시지 표시
                showErrorMessage(`데이터 로드 실패: ${error.message}. 샘플 데이터를 표시합니다.`);
                
                // 샘플 데이터 반환
                return {
                    ...sampleData,
                    lastUpdate: new Date().toISOString()
                };
            } finally {
                showLoading(false);
            }
        }

        // 로딩 상태 표시
        function showLoading(show) {
            const button = document.querySelector('.refresh-btn');
            if (show) {
                button.disabled = true;
                button.textContent = '🔄 로딩 중...';
            } else {
                button.disabled = false;
                button.textContent = '📊 데이터 새로고침';
            }
        }

        // 오류 메시지 표시
        function showErrorMessage(message) {
            // 기존 오류 메시지 제거
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // 새 오류 메시지 생성
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.cssText = `
                background: #ffebee;
                color: #c62828;
                padding: 10px;
                border-radius: 5px;
                margin: 10px 0;
                border-left: 4px solid #f44336;
            `;
            errorDiv.textContent = message;
            
            // 데이터 새로고침 버튼 다음에 삽입
            const refreshSection = document.querySelector('.data-refresh');
            refreshSection.parentNode.insertBefore(errorDiv, refreshSection.nextSibling);
            
            // 5초 후 자동 제거
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // 데이터 로드 및 UI 업데이트
        async function loadVOCData() {
            const data = await fetchVOCData();
            
            updateReasonStatsTable(data.reasonStats);
            updatePriorityTable(data.priorityData);
            updateCharts(data);
            generateInsights(data);
            
            // 업데이트 시간 표시
            const updateTime = data.lastUpdate ? 
                new Date(data.lastUpdate).toLocaleString('ko-KR') : 
                new Date().toLocaleString('ko-KR');
            document.getElementById('lastUpdate').textContent = updateTime;
        }

        // 주요 신청사유 테이블 업데이트
        function updateReasonStatsTable(reasonStats) {
            const tbody = document.getElementById('reasonStatsTable');
            tbody.innerHTML = '';
            
            reasonStats.forEach(stat => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${stat.reason_category}</td>
                    <td>${stat.count.toLocaleString()}</td>
                    <td class="percentage">${stat.percentage}%</td>
                `;
            });
        }

        // 우선순위 테이블 업데이트
        function updatePriorityTable(priorityData) {
            const tbody = document.getElementById('priorityTable');
            tbody.innerHTML = '';
            
            priorityData.forEach(priority => {
                const row = tbody.insertRow();
                let priorityClass = '';
                if (priority.priority_score > 70) priorityClass = 'priority-high';
                else if (priority.priority_score > 40) priorityClass = 'priority-medium';
                else priorityClass = 'priority-low';
                
                row.className = priorityClass;
                row.innerHTML = `
                    <td>${priority.reason_category}</td>
                    <td>${priority.frequency}</td>
                    <td>${priority.avg_urgency.toFixed(1)}</td>
                    <td>${priority.priority_score.toFixed(1)}</td>
                `;
            });
        }

        // 차트 업데이트
        function updateCharts(data) {
            // 월별 트렌드 차트
            updateMonthlyTrendChart(data.monthlyTrend);
            
            // 시간대별 차트
            updateHourlyChart(data.hourlyData);
            
            // 고객 유형별 차트
            updateCustomerTypeChart(data.customerData);
        }

        function updateMonthlyTrendChart(monthlyData) {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            
            if (charts.monthly) {
                charts.monthly.destroy();
            }
            
            const months = [...new Set(monthlyData.map(item => item.month))].sort();
            const categories = [...new Set(monthlyData.map(item => item.reason_category))];
            
            const datasets = categories.map((category, index) => {
                const data = months.map(month => {
                    const found = monthlyData.find(item => item.month === month && item.reason_category === category);
                    return found ? found.count : 0;
                });
                
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'];
                return {
                    label: category,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.4
                };
            });

            charts.monthly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function updateHourlyChart(hourlyData) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            if (charts.hourly) {
                charts.hourly.destroy();
            }
            
            charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hourlyData.map(item => item.hour + '시'),
                    datasets: [{
                        label: 'VOC 건수',
                        data: hourlyData.map(item => item.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateCustomerTypeChart(customerData) {
            const ctx = document.getElementById('customerTypeChart').getContext('2d');
            
            if (charts.customer) {
                charts.customer.destroy();
            }
            
            charts.customer = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: customerData.map(item => item.customer_type),
                    datasets: [{
                        data: customerData.map(item => item.count),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // 인사이트 생성
        function generateInsights(data) {
            const insights = [];
            
            // VOC 유형별 해석
            const vocTypeNames = {
                'K2K_SALES': 'K2K 영업',
                'K2G_SALES': 'K2G 영업', 
                'RETENTION': '해지방어/재영업',
                'K2K_MARKET': 'K2K 마케팅',
                'K2G_MARKET': 'K2G 마케팅',
                'TOP_SALES': '참고사항',
                'ETC': '기타'
            };
            
            // 가장 많은 VOC 유형
            if (data.reasonStats.length > 0) {
                const topReason = data.reasonStats[0];
                const typeName = vocTypeNames[topReason.reason_category] || topReason.reason_category;
                insights.push(`가장 많은 VOC 유형은 "${typeName}"로 전체의 ${topReason.percentage}%를 차지합니다.`);
            }
            
            // 우선순위가 높은 개선사항
            if (data.priorityData.length > 0) {
                const highPriority = data.priorityData[0];
                const typeName = vocTypeNames[highPriority.reason_category] || highPriority.reason_category;
                insights.push(`"${typeName}" 관련 업무가 가장 시급합니다. (우선순위 점수: ${Math.round(highPriority.priority_score)})`);
            }
            
            // 시간대 분석
            if (data.hourlyData.length > 0) {
                const peakHour = data.hourlyData.reduce((max, current) => current.count > max.count ? current : max);
                insights.push(`VOC가 가장 많이 발생하는 시간은 ${peakHour.hour}시입니다. 이 시간대 영업 활동이 활발합니다.`);
            }
            
            // 쇼핑몰 분석
            if (data.customerData.length > 0) {
                const topMall = data.customerData.reduce((max, current) => current.count > max.count ? current : max);
                insights.push(`"${topMall.customer_type}" 쇼핑몰에서 가장 많은 VOC가 발생합니다. 집중 관리가 필요합니다.`);
            }
            
            // 영업 전략 제안
            const salesVOC = data.reasonStats.filter(item => 
                item.reason_category === 'K2K_SALES' || item.reason_category === 'K2G_SALES'
            );
            if (salesVOC.length > 0) {
                const totalSales = salesVOC.reduce((sum, item) => sum + item.count, 0);
                insights.push(`영업 관련 VOC가 ${totalSales}건 발생했습니다. 영업 프로세스 최적화를 검토하세요.`);
            }
            
            // 해지방어 분석
            const retention = data.reasonStats.find(item => item.reason_category === 'RETENTION');
            if (retention && retention.count > 0) {
                insights.push(`해지방어 VOC가 ${retention.count}건(${retention.percentage}%) 발생했습니다. 고객 유지 전략을 강화하세요.`);
            }
            
            insights.push("정기적인 VOC 모니터링을 통해 영업 성과를 지속적으로 개선하세요.");
            
            const insightsList = document.getElementById('insights-list');
            insightsList.innerHTML = '';
            insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                insightsList.appendChild(li);
            });
        }

        // 페이지 로드 시 데이터 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadVOCData();
        });

        // 자동 새로고침 기능 (옵션)
        function enableAutoRefresh(intervalMinutes = 5) {
            setInterval(() => {
                console.log('자동 새로고침 실행...');
                loadVOCData();
            }, intervalMinutes * 60 * 1000);
        }

        // 특정 데이터만 업데이트하는 함수들
        async function updateSpecificData(dataType) {
            try {
                const response = await fetch(`${API_BASE_URL}?type=${dataType}&timestamp=${Date.now()}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                return data;
            } catch (error) {
                console.error(`${dataType} 데이터 업데이트 실패:`, error);
                throw error;
            }
        }

        // 실시간 업데이트 웹소켓 연결 (향후 확장용)
        function initWebSocketConnection() {
            // WebSocket 실시간 업데이트 구현 예정
            // const ws = new WebSocket('ws://localhost:8080/voc-updates');
        }
    </script>
</body>
</html>