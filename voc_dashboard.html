<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOC ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 10px;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th,
        .stats-table td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .stats-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .percentage {
            color: #667eea;
            font-weight: bold;
        }

        .priority-high {
            background: #ffebee;
            color: #c62828;
        }

        .priority-medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .priority-low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .insights {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .insights h3 {
            color: #d84315;
            margin-bottom: 15px;
        }

        .insights ul {
            list-style-type: none;
        }

        .insights li {
            padding: 8px 0;
            border-left: 3px solid #ff5722;
            padding-left: 15px;
            margin-bottom: 10px;
        }

        .data-refresh {
            text-align: center;
            margin: 20px 0;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š VOC ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ì„œë¹„ìŠ¤ ê³ ë„í™” ë° ì˜ì—…ë©”ì‹œì§€ ê°•í™”ë¥¼ ìœ„í•œ ê³ ê° ì˜ê²¬ ë¶„ì„</p>
    </div>

    <div class="container">
        <div class="data-refresh">
            <button class="refresh-btn" onclick="loadVOCData()">ğŸ“Š ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
            <p><small>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span></small></p>
        </div>

        <!-- KPI ì¹´ë“œë“¤ -->
        <div class="dashboard-grid">
            
            <!-- ì£¼ìš” VOC ìœ í˜• í†µê³„ -->
            <div class="card">
                <h3>ğŸ”¥ VOC ìœ í˜•ë³„ ë¶„í¬</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>VOC ìœ í˜•</th>
                            <th>ê±´ìˆ˜</th>
                            <th>ë¹„ìœ¨</th>
                        </tr>
                    </thead>
                    <tbody id="reasonStatsTable">
                        <!-- ë°ì´í„° ë¡œë”© ì¤‘... -->
                    </tbody>
                </table>
            </div>

            <!-- ì„œë¹„ìŠ¤ ê°œì„  ìš°ì„ ìˆœìœ„ -->
            <div class="card">
                <h3>âš¡ ì„œë¹„ìŠ¤ ê°œì„  ìš°ì„ ìˆœìœ„</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <th>ë¹ˆë„</th>
                            <th>ê¸´ê¸‰ë„</th>
                            <th>ìš°ì„ ìˆœìœ„</th>
                        </tr>
                    </thead>
                    <tbody id="priorityTable">
                        <!-- ë°ì´í„° ë¡œë”© ì¤‘... -->
                    </tbody>
                </table>
            </div>

            <!-- ì›”ë³„ íŠ¸ë Œë“œ ì°¨íŠ¸ -->
            <div class="card" style="grid-column: span 2;">
                <h3>ğŸ“ˆ ì›”ë³„ VOC íŠ¸ë Œë“œ</h3>
                <div class="chart-container">
                    <canvas id="monthlyTrendChart"></canvas>
                </div>
            </div>

            <!-- ì‹œê°„ëŒ€ë³„ ë¶„í¬ -->
            <div class="card">
                <h3>ğŸ• ì‹œê°„ëŒ€ë³„ VOC ë¶„í¬</h3>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <!-- ì‡¼í•‘ëª°ë³„ ë¶„ì„ -->
            <div class="card">
                <h3>ğŸª ì‡¼í•‘ëª°ë³„ VOC ë¶„í¬</h3>
                <div class="chart-container">
                    <canvas id="customerTypeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜ -->
        <div class="insights">
            <h3>ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ ë° ì•¡ì…˜ ì•„ì´í…œ</h3>
            <ul id="insights-list">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </ul>
        </div>
    </div>

    <script>
        // API ì„¤ì •
        const API_BASE_URL = './api/voc_data.php';
        
        // ìƒ˜í”Œ ë°ì´í„° (API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ í´ë°±)
        const sampleData = {
            reasonStats: [
                {reason_category: 'K2K_SALES', count: 245, percentage: 28.5},
                {reason_category: 'K2G_SALES', count: 187, percentage: 21.7},
                {reason_category: 'RETENTION', count: 156, percentage: 18.1},
                {reason_category: 'K2K_MARKET', count: 98, percentage: 11.4},
                {reason_category: 'K2G_MARKET', count: 76, percentage: 8.8},
                {reason_category: 'TOP_SALES', count: 54, percentage: 6.3},
                {reason_category: 'ETC', count: 32, percentage: 3.7}
            ],
            priorityData: [
                {reason_category: 'K2K_SALES', frequency: 245, avg_urgency: 5.0, priority_score: 1225.0},
                {reason_category: 'K2G_SALES', frequency: 187, avg_urgency: 4.8, priority_score: 897.6},
                {reason_category: 'RETENTION', frequency: 156, avg_urgency: 4.5, priority_score: 702.0},
                {reason_category: 'K2K_MARKET', frequency: 98, avg_urgency: 4.2, priority_score: 411.6},
                {reason_category: 'K2G_MARKET', frequency: 76, avg_urgency: 4.0, priority_score: 304.0}
            ],
            monthlyTrend: [
                {month: '2024-09', reason_category: 'K2K_SALES', count: 82},
                {month: '2024-09', reason_category: 'K2G_SALES', count: 65},
                {month: '2024-10', reason_category: 'K2K_SALES', count: 95},
                {month: '2024-10', reason_category: 'K2G_SALES', count: 78},
                {month: '2024-11', reason_category: 'K2K_SALES', count: 103},
                {month: '2024-11', reason_category: 'K2G_SALES', count: 89}
            ],
            hourlyData: [
                {hour: 9, count: 45}, {hour: 10, count: 67}, {hour: 11, count: 89},
                {hour: 12, count: 95}, {hour: 13, count: 78}, {hour: 14, count: 123},
                {hour: 15, count: 145}, {hour: 16, count: 167}, {hour: 17, count: 134},
                {hour: 18, count: 98}, {hour: 19, count: 76}, {hour: 20, count: 54}
            ],
            customerData: [
                {customer_type: 'mall66', count: 423},
                {customer_type: 'mall77', count: 267},
                {customer_type: 'mall88', count: 198},
                {customer_type: 'mall99', count: 89},
                {customer_type: 'mall55', count: 45}
            ]
        };

        let charts = {};

        // APIì—ì„œ VOC ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchVOCData() {
            try {
                showLoading(true);
                
                const response = await fetch(`${API_BASE_URL}?type=all&timestamp=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // API ì˜¤ë¥˜ ì‘ë‹µ ì²´í¬
                if (data.error) {
                    throw new Error(data.message || 'API ì˜¤ë¥˜ ë°œìƒ');
                }
                
                return data;
                
            } catch (error) {
                console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                
                // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                showErrorMessage(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}. ìƒ˜í”Œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`);
                
                // ìƒ˜í”Œ ë°ì´í„° ë°˜í™˜
                return {
                    ...sampleData,
                    lastUpdate: new Date().toISOString()
                };
            } finally {
                showLoading(false);
            }
        }

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        function showLoading(show) {
            const button = document.querySelector('.refresh-btn');
            if (show) {
                button.disabled = true;
                button.textContent = 'ğŸ”„ ë¡œë”© ì¤‘...';
            } else {
                button.disabled = false;
                button.textContent = 'ğŸ“Š ë°ì´í„° ìƒˆë¡œê³ ì¹¨';
            }
        }

        // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        function showErrorMessage(message) {
            // ê¸°ì¡´ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // ìƒˆ ì˜¤ë¥˜ ë©”ì‹œì§€ ìƒì„±
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.cssText = `
                background: #ffebee;
                color: #c62828;
                padding: 10px;
                border-radius: 5px;
                margin: 10px 0;
                border-left: 4px solid #f44336;
            `;
            errorDiv.textContent = message;
            
            // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ë‹¤ìŒì— ì‚½ì…
            const refreshSection = document.querySelector('.data-refresh');
            refreshSection.parentNode.insertBefore(errorDiv, refreshSection.nextSibling);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // ë°ì´í„° ë¡œë“œ ë° UI ì—…ë°ì´íŠ¸
        async function loadVOCData() {
            const data = await fetchVOCData();
            
            updateReasonStatsTable(data.reasonStats);
            updatePriorityTable(data.priorityData);
            updateCharts(data);
            generateInsights(data);
            
            // ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
            const updateTime = data.lastUpdate ? 
                new Date(data.lastUpdate).toLocaleString('ko-KR') : 
                new Date().toLocaleString('ko-KR');
            document.getElementById('lastUpdate').textContent = updateTime;
        }

        // ì£¼ìš” ì‹ ì²­ì‚¬ìœ  í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateReasonStatsTable(reasonStats) {
            const tbody = document.getElementById('reasonStatsTable');
            tbody.innerHTML = '';
            
            reasonStats.forEach(stat => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${stat.reason_category}</td>
                    <td>${stat.count.toLocaleString()}</td>
                    <td class="percentage">${stat.percentage}%</td>
                `;
            });
        }

        // ìš°ì„ ìˆœìœ„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updatePriorityTable(priorityData) {
            const tbody = document.getElementById('priorityTable');
            tbody.innerHTML = '';
            
            priorityData.forEach(priority => {
                const row = tbody.insertRow();
                let priorityClass = '';
                if (priority.priority_score > 70) priorityClass = 'priority-high';
                else if (priority.priority_score > 40) priorityClass = 'priority-medium';
                else priorityClass = 'priority-low';
                
                row.className = priorityClass;
                row.innerHTML = `
                    <td>${priority.reason_category}</td>
                    <td>${priority.frequency}</td>
                    <td>${priority.avg_urgency.toFixed(1)}</td>
                    <td>${priority.priority_score.toFixed(1)}</td>
                `;
            });
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts(data) {
            // ì›”ë³„ íŠ¸ë Œë“œ ì°¨íŠ¸
            updateMonthlyTrendChart(data.monthlyTrend);
            
            // ì‹œê°„ëŒ€ë³„ ì°¨íŠ¸
            updateHourlyChart(data.hourlyData);
            
            // ê³ ê° ìœ í˜•ë³„ ì°¨íŠ¸
            updateCustomerTypeChart(data.customerData);
        }

        function updateMonthlyTrendChart(monthlyData) {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            
            if (charts.monthly) {
                charts.monthly.destroy();
            }
            
            const months = [...new Set(monthlyData.map(item => item.month))].sort();
            const categories = [...new Set(monthlyData.map(item => item.reason_category))];
            
            const datasets = categories.map((category, index) => {
                const data = months.map(month => {
                    const found = monthlyData.find(item => item.month === month && item.reason_category === category);
                    return found ? found.count : 0;
                });
                
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'];
                return {
                    label: category,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.4
                };
            });

            charts.monthly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function updateHourlyChart(hourlyData) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            if (charts.hourly) {
                charts.hourly.destroy();
            }
            
            charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hourlyData.map(item => item.hour + 'ì‹œ'),
                    datasets: [{
                        label: 'VOC ê±´ìˆ˜',
                        data: hourlyData.map(item => item.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateCustomerTypeChart(customerData) {
            const ctx = document.getElementById('customerTypeChart').getContext('2d');
            
            if (charts.customer) {
                charts.customer.destroy();
            }
            
            charts.customer = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: customerData.map(item => item.customer_type),
                    datasets: [{
                        data: customerData.map(item => item.count),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // ì¸ì‚¬ì´íŠ¸ ìƒì„±
        function generateInsights(data) {
            const insights = [];
            
            // VOC ìœ í˜•ë³„ í•´ì„
            const vocTypeNames = {
                'K2K_SALES': 'K2K ì˜ì—…',
                'K2G_SALES': 'K2G ì˜ì—…', 
                'RETENTION': 'í•´ì§€ë°©ì–´/ì¬ì˜ì—…',
                'K2K_MARKET': 'K2K ë§ˆì¼€íŒ…',
                'K2G_MARKET': 'K2G ë§ˆì¼€íŒ…',
                'TOP_SALES': 'ì°¸ê³ ì‚¬í•­',
                'ETC': 'ê¸°íƒ€'
            };
            
            // ê°€ì¥ ë§ì€ VOC ìœ í˜•
            if (data.reasonStats.length > 0) {
                const topReason = data.reasonStats[0];
                const typeName = vocTypeNames[topReason.reason_category] || topReason.reason_category;
                insights.push(`ê°€ì¥ ë§ì€ VOC ìœ í˜•ì€ "${typeName}"ë¡œ ì „ì²´ì˜ ${topReason.percentage}%ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤.`);
            }
            
            // ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ ê°œì„ ì‚¬í•­
            if (data.priorityData.length > 0) {
                const highPriority = data.priorityData[0];
                const typeName = vocTypeNames[highPriority.reason_category] || highPriority.reason_category;
                insights.push(`"${typeName}" ê´€ë ¨ ì—…ë¬´ê°€ ê°€ì¥ ì‹œê¸‰í•©ë‹ˆë‹¤. (ìš°ì„ ìˆœìœ„ ì ìˆ˜: ${Math.round(highPriority.priority_score)})`);
            }
            
            // ì‹œê°„ëŒ€ ë¶„ì„
            if (data.hourlyData.length > 0) {
                const peakHour = data.hourlyData.reduce((max, current) => current.count > max.count ? current : max);
                insights.push(`VOCê°€ ê°€ì¥ ë§ì´ ë°œìƒí•˜ëŠ” ì‹œê°„ì€ ${peakHour.hour}ì‹œì…ë‹ˆë‹¤. ì´ ì‹œê°„ëŒ€ ì˜ì—… í™œë™ì´ í™œë°œí•©ë‹ˆë‹¤.`);
            }
            
            // ì‡¼í•‘ëª° ë¶„ì„
            if (data.customerData.length > 0) {
                const topMall = data.customerData.reduce((max, current) => current.count > max.count ? current : max);
                insights.push(`"${topMall.customer_type}" ì‡¼í•‘ëª°ì—ì„œ ê°€ì¥ ë§ì€ VOCê°€ ë°œìƒí•©ë‹ˆë‹¤. ì§‘ì¤‘ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
            }
            
            // ì˜ì—… ì „ëµ ì œì•ˆ
            const salesVOC = data.reasonStats.filter(item => 
                item.reason_category === 'K2K_SALES' || item.reason_category === 'K2G_SALES'
            );
            if (salesVOC.length > 0) {
                const totalSales = salesVOC.reduce((sum, item) => sum + item.count, 0);
                insights.push(`ì˜ì—… ê´€ë ¨ VOCê°€ ${totalSales}ê±´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì˜ì—… í”„ë¡œì„¸ìŠ¤ ìµœì í™”ë¥¼ ê²€í† í•˜ì„¸ìš”.`);
            }
            
            // í•´ì§€ë°©ì–´ ë¶„ì„
            const retention = data.reasonStats.find(item => item.reason_category === 'RETENTION');
            if (retention && retention.count > 0) {
                insights.push(`í•´ì§€ë°©ì–´ VOCê°€ ${retention.count}ê±´(${retention.percentage}%) ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³ ê° ìœ ì§€ ì „ëµì„ ê°•í™”í•˜ì„¸ìš”.`);
            }
            
            insights.push("ì •ê¸°ì ì¸ VOC ëª¨ë‹ˆí„°ë§ì„ í†µí•´ ì˜ì—… ì„±ê³¼ë¥¼ ì§€ì†ì ìœ¼ë¡œ ê°œì„ í•˜ì„¸ìš”.");
            
            const insightsList = document.getElementById('insights-list');
            insightsList.innerHTML = '';
            insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                insightsList.appendChild(li);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            loadVOCData();
        });

        // ìë™ ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥ (ì˜µì…˜)
        function enableAutoRefresh(intervalMinutes = 5) {
            setInterval(() => {
                console.log('ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰...');
                loadVOCData();
            }, intervalMinutes * 60 * 1000);
        }

        // íŠ¹ì • ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ë“¤
        async function updateSpecificData(dataType) {
            try {
                const response = await fetch(`${API_BASE_URL}?type=${dataType}&timestamp=${Date.now()}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                return data;
            } catch (error) {
                console.error(`${dataType} ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
                throw error;
            }
        }

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì›¹ì†Œì¼“ ì—°ê²° (í–¥í›„ í™•ì¥ìš©)
        function initWebSocketConnection() {
            // WebSocket ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬í˜„ ì˜ˆì •
            // const ws = new WebSocket('ws://localhost:8080/voc-updates');
        }
    </script>
</body>
</html>